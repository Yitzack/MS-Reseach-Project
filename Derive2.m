e1={0, .1, .2, .3, .4, .5, .6, .7, .8, .9, 1, 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7, 1.8, 1.9, 2, 2.1, 2.2, 2.3, 2.4, 2.5, 2.540308, 2.545308, 2.550308, 2.555308, 2.560308, 2.565308, 2.570308, 2.575308, 2.580308, 2.585308, 2.590308, 2.595308, 2.600308, 2.605308, 2.610308, 2.615308, 2.620308, 2.625308, 2.630308, 2.635308, 2.640308, 2.645308, 2.650308, 2.655308, 2.660308, 2.665308, 2.670308, 2.675308, 2.680308, 2.685308, 2.690308, 2.695308, 2.700308, 2.705308, 2.710308, 2.715308, 2.720308, 2.725308, 2.730308, 2.735308, 2.740308, 2.745308, 2.750308, 2.755308, 2.760308, 2.765308, 2.770308, 2.775308, 2.780308, 2.785308, 2.790308, 2.795308, 2.800308, 2.805308, 2.810308, 2.815308, 2.820308, 2.825308, 2.830308, 2.835308, 2.840308, 2.845308, 2.850308, 2.855308, 2.860308, 2.865308, 2.870308, 2.875308, 2.880308, 2.885308, 2.890308, 2.895308, 2.900308, 2.905308, 2.910308, 2.915308, 2.920308, 2.925308, 2.930308, 2.935308, 2.940308, 2.945308, 2.950308, 2.955308, 2.960308, 2.965308, 2.970308, 2.975308, 2.980308, 2.985308, 2.990308, 2.995308, 3.000308, 3.005308, 3.010308, 3.015308, 3.020308, 3.025308, 3.030308, 3.035308, 3.040308, 3.045308, 3.050308, 3.055308, 3.060308, 3.065308, 3.070308, 3.075308, 3.080308, 3.085308, 3.090308, 3.095308, 3.100308, 3.105308, 3.110308, 3.115308, 3.120308, 3.125308, 3.130308, 3.135308, 3.140308, 3.145308, 3.150308, 3.155308, 3.160308, 3.165308, 3.170308, 3.175308, 3.180308, 3.185308, 3.190308, 3.195308, 3.200308, 3.205308, 3.210308, 3.215308, 3.220308, 3.225308, 3.230308, 3.235308, 3.240308, 3.245308, 3.250308, 3.255308, 3.260308, 3.265308, 3.270308, 3.275308, 3.280308, 3.285308, 3.290308, 3.295308, 3.300308, 3.305308, 3.310308, 3.315308, 3.320308, 3.325308, 3.330308, 3.335308, 3.340308, 3.345308, 3.350308, 3.355308, 3.360308, 3.365308, 3.370308, 3.375308, 3.380308, 3.385308, 3.390308, 3.395308, 3.400308, 3.405308, 3.410308, 3.415308, 3.420308, 3.425308, 3.430308, 3.435308, 3.440308, 3.445308, 3.450308, 3.455308, 3.460308, 3.465308, 3.470308, 3.475308, 3.480308, 3.485308, 3.490308, 3.495308, 3.500308, 3.505308, 3.510308, 3.515308, 3.520308, 3.525308, 3.530308, 3.535308, 3.540308, 3.55, 3.56375, 3.5775, 3.59125, 3.605, 3.61875, 3.6325, 3.64625, 3.66, 3.67375, 3.6875,  3.70125, 3.715, 3.72875, 3.7425, 3.75625, 3.77, 3.78375, 3.7975, 3.81125, 3.825, 3.83875, 3.8525, 3.86625, 3.88, 3.89375, 3.9075, 3.92125, 3.935, 3.94875, 3.9625, 3.97625, 3.99, 4.00375, 4.0175, 4.03125, 4.045, 4.05875, 4.0725, 4.08625, 4.1, 4.2, 4.3, 4.4, 4.5, 4.6, 4.7, 4.8, 4.9, 5, 5.1, 5.2, 5.3, 5.4, 5.5, 5.6, 5.7, 5.8, 5.9, 6, 6.1, 6.2, 6.3, 6.4, 6.5, 6.6, 6.7, 6.8, 6.9, 7, 7.1, 7.2, 7.3, 7.4, 7.5, 7.6, 7.7, 7.8, 7.9, 8, 8.1, 8.2, 8.3, 8.4, 8.5, 8.6, 8.7, 8.8, 8.9, 9, 9.1, 9.2, 9.3, 9.4, 9.5, 9.6, 9.7, 9.8, 9.9, 10, 10.1, 10.2, 10.3, 10.4, 10.5, 10.6, 10.7, 10.8, 10.9, 11, 11.1, 11.2, 11.3, 11.4, 11.5, 11.6, 11.7, 11.8, 11.9, 12, 12.1, 12.2, 12.3, 12.4, 12.5, 12.6, 12.7, 12.8, 12.9, 13, 13.1, 13.2, 13.3, 13.4, 13.5, 13.6, 13.7, 13.8, 13.9, 14, 14.1, 14.2, 14.3, 14.4, 14.5, 14.6, 14.7, 14.8, 14.9, 15, 15.1, 15.2, 15.3, 15.4, 15.5, 15.6, 15.7, 15.8, 15.9, 16, 16.1, 16.2, 16.3, 16.4, 16.5, 16.6, 16.7, 16.8, 16.9, 17, 17.1, 17.2, 17.3, 17.4, 17.5, 17.6, 17.7, 17.8, 17.9, 18, 18.1, 18.2, 18.3, 18.4, 18.5, 18.6, 18.7, 18.8, 18.9, 19, 19.1, 19.2, 19.3, 19.4, 19.5, 19.6, 19.7, 19.8, 19.9, 20, 20.1, 20.2, 20.3, 20.4, 20.5, 20.6, 20.7, 20.8, 20.9, 21., 21.1, 21.2, 21.3, 21.4, 21.5, 21.6, 21.7, 21.8, 21.9, 22., 22.1, 22.2, 22.3, 22.4, 22.5, 22.6, 22.7, 22.8, 22.9, 23., 23.1, 23.2, 23.3, 23.4, 23.5}^2; (*s abscissa*)
Par={-26.796184939764153, 8.66343167061543, 1.8, 0, 0};
GaussLa={0.0292089494940390418, 0.1539325380822080769, 0.3784519114339929046, 0.703043968841429832, 1.12804449030959115901, 1.65388906539884363591, 2.28111923347644653209, 3.01038628120128830529, 3.84245522739668292116, 4.77820943138205453677, 5.81865597642423461728, 6.96493193346708690195, 8.2183116110416122313, 9.58021491185883249065, 11.0522169380215279328, 12.63605901385725832108, 14.33366132857440339499, 16.14713744153402449126, 18.07881094274913343943, 20.13123462273780157763, 22.3072125823387678126, 24.60982580889231094881, 27.04246186610561423232, 29.60884949880154539486, 32.31309915127963456172, 35.15975065392247902555, 38.15382966748456817771, 41.3009149171740471975, 44.60721884062876818128, 48.0796850753673570501, 51.72610731101421216486, 55.55527556274067844963, 59.5771580886221159235, 63.80313029304261238365, 68.24626653908353044698, 72.92171766800947991981, 77.84720759844820215182, 83.04369909859864667464, 88.53630611197943572002, 94.35557619641319288989, 100.53934816696116679177, 107.13554136224855814149, 114.20653122712858723725, 121.83639878660318539969, 130.14381522449526055617, 139.30719756334274304328, 149.62081975792771442406, 161.64877015704720903095, 176.84630940701588372409};

input = $CommandLine

Master = Import[StringJoin[Directory[],"/",input[[Dimensions[input]]],".xml"]]; (*Import the table for interpolation extrapolation*)
ImG1=Interpolation[Transpose[{Master[[1,All,1]],Master[[1,All,2,1]]}],Method->"Spline",InterpolationOrder->1]; (*Extract the subtables*)
ImGv1=Interpolation[Transpose[{Master[[1,All,1]],Master[[1,All,2,2]]}],Method->"Spline",InterpolationOrder->1];
ImGV1=Interpolation[Transpose[{Master[[1,All,1]],Master[[1,All,2,3]]}],Method->"Spline",InterpolationOrder->1];
ReGv1=Interpolation[Transpose[{Master[[1,All,1]],Master[[1,All,2,4]]}],Method->"Spline",InterpolationOrder->1];
ReGV1=Interpolation[Transpose[{Master[[1,All,1]],Master[[1,All,2,5]]}],Method->"Spline",InterpolationOrder->1];
ImG2=Interpolation[Transpose[{Master[[2,All,1]],Master[[2,All,2,1]]}],Method->"Spline",InterpolationOrder->1];
ImGv2=Interpolation[Transpose[{Master[[2,All,1]],Master[[2,All,2,2]]}],Method->"Spline",InterpolationOrder->1];
ImGV2=Interpolation[Transpose[{Master[[2,All,1]],Master[[2,All,2,3]]}],Method->"Spline",InterpolationOrder->1];
ReGv2=Interpolation[Transpose[{Master[[2,All,1]],Master[[2,All,2,4]]}],Method->"Spline",InterpolationOrder->1];
ReGV2=Interpolation[Transpose[{Master[[2,All,1]],Master[[2,All,2,5]]}],Method->"Spline",InterpolationOrder->1];
ImG3=Interpolation[Transpose[{Master[[3,All,1]],Master[[3,All,2,1]]}],Method->"Spline"];
ImGv3=Interpolation[Transpose[{Master[[3,All,1]],Master[[3,All,2,2]]}],Method->"Spline"];
ImGV3=Interpolation[Transpose[{Master[[3,All,1]],Master[[3,All,2,3]]}],Method->"Spline"];
ReGv3=Interpolation[Transpose[{Master[[3,All,1]],Master[[3,All,2,4]]}],Method->"Spline"];
ReGV3=Interpolation[Transpose[{Master[[3,All,1]],Master[[3,All,2,5]]}],Method->"Spline"];

Gv1[i_,j_]:=(ReGv1[i,j]+I*ImGv1[i,j]);
GV1[i_,j_]:=(ReGV1[i,j]+I*ImGV1[i,j]);
Gv2[i_,j_]:=(ReGv2[i,j]+I*ImGv2[i,j]);
GV2[i_,j_]:=(ReGV2[i,j]+I*ImGV2[i,j]);
Gv3[P_,s_]:=(ReGv3[P,s]+I*ImGv3[P,s]);
GV3[P_,s_]:=(ReGV3[P,s]+I*ImGV3[P,s]);

s[i_,j_]:=If[j<=150,If[i<=208,-i*j/50.-j^2/100.,-j/5.*(i-187.2)-j^2/100.],If[j<=181,(j-151.)^2/100.,If[j<=381,((j-181.)/100.+3.)^2,If[j<=566,((j-381.)/10.+5.)^2,552.25+GaussLa[[j-566]]]]]]
V[s_]:=Par[[1]]*(Par[[2]]^4/(Par[[2]]^4+s^2)) (*TMatrix definition*)

TMat1[i_,j_]:=V[s[i,j]]/(1-GV1[i,j])
TMat2[i_,j_]:=V[s[i,j]]/(1-GV2[i,j])
TMat3[P_,s_]:=V[s]/(1-GV3[P,s])
Spectral1[i_,j_]:=-18/Pi*(ImG1[i,j]+Im[Par[[1]]*Gv1[i,j]^2/(1-GV1[i,j])])
Spectral2[i_,j_]:=-18/Pi*(ImG2[i,j]+Im[Par[[1]]*Gv2[i,j]^2/(1-GV2[i,j])])
Spectral3[P_,s_]:=-18/Pi*(ImG3[P,s]+Im[Par[[1]]*Gv3[P,s]^2/(1-GV3[P,s])])
SpectralInt1=Interpolation[Flatten[Table[{{i,j},Spectral1[i,j]},{i,0,208},{j,0,150}],1]];
SpectralInt2=Interpolation[Flatten[Table[{{i,j},Spectral2[i,j]},{i,208,788},{j,0,150}],1]];
SpectralInt3=Interpolation[Flatten[Table[{{P,e1[[i]]},Spectral3[P,e1[[i]]]},{P,0,600.8,.8},{i,462}],1]];

List1T = Flatten[Table[{i,j,TMat1[i,j]},{i,0,208},{j,0,150}],1]; (*Calculate the derivatives and the function itself*)
List2T = Flatten[Table[{i,j,TMat2[i,j]},{i,208,788},{j,0,150}],1]; (*Calculate the derivatives and the function itself*)
List3T = Flatten[Table[{P,e1[[i]],TMat3[P,e1[[i]]]},{P,0,600.8,.8},{i,462}],1]; (*Calculate the derivatives and the function itself*)
List0 = Flatten[Table[SpectralInt1[i,j], {i,0,208}, {j,0,150}]];
List1 = Flatten[Table[D[SpectralInt1[i,j],i]/.{i->ic,j->jc},{ic,0,208},{jc,0,150}]];
List2 = Flatten[Table[D[SpectralInt1[i,j],j]/.{i->ic,j->jc},{ic,0,208},{jc,0,150}]];
List3 = Flatten[Table[D[SpectralInt1[i,j],i,j]/.{i->ic,j->jc},{ic,0,208},{jc,0,150}]];
List4 = Flatten[Table[SpectralInt2[i,j], {i,208,788}, {j,0,150}]];
List5 = Flatten[Table[D[SpectralInt2[i,j],i]/.{i->ic,j->jc},{ic,208,788},{jc,0,150}]];
List6 = Flatten[Table[D[SpectralInt2[i,j],j]/.{i->ic,j->jc},{ic,208,788},{jc,0,150}]];
List7 = Flatten[Table[D[SpectralInt2[i,j],i,j]/.{i->ic,j->jc},{ic,208,788},{jc,0,150}]];
List8 = Flatten[Table[SpectralInt3[P, e1[[i]]], {P, 0, 600.8, .8}, {i, 462}]];
List9 = Flatten[Table[D[SpectralInt3[P,e],P]/.{P->i,e->e1[[j]]},{i,0,600.8,.8},{j,462}]];
List10 = Flatten[Table[2*Sqrt[e]*D[SpectralInt3[P,e],e]/.{P->i,e->e1[[j]]},{i,0,600.8,.8},{j,462}]]; (*2*Sqrt[e]* is to change the derivative from d/ds to d/d(sqrt(s))*)
List11 = Flatten[Table[2*Sqrt[e]*D[SpectralInt3[P,e],P,e]/.{P->i,e->e1[[j]]},{i,0,600.8,.8},{j,462}]];

Export[StringJoin[Directory[],"/",input[[Dimensions[input]]],".csv"], Join[Transpose[{List1T[[All, 1]], List1T[[All, 2]], Re[List1T[[All, 3]]], Im[List1T[[All, 3]]], List0, List1, List2, List3}],Transpose[{List2T[[All, 1]], List2T[[All, 2]], Re[List2T[[All, 3]]], Im[List2T[[All, 3]]], List4, List5, List6, List7}],Transpose[{List3T[[All, 1]], List3T[[All, 2]], Re[List3T[[All, 3]]], Im[List3T[[All, 3]]], List8, List9, List10, List11}]]] (*Export the table*)

Print["Error1"]

ReGv1=Interpolation[Transpose[{Master[[1,All,1]],Master[[1,All,2,4]]}],Method->"Spline"];
ReGV1=Interpolation[Transpose[{Master[[1,All,1]],Master[[1,All,2,5]]}],Method->"Spline"];
ReGv2=Interpolation[Transpose[{Master[[2,All,1]],Master[[2,All,2,4]]}],Method->"Spline"];
ReGV2=Interpolation[Transpose[{Master[[2,All,1]],Master[[2,All,2,5]]}],Method->"Spline"];
ReGv3=Interpolation[Transpose[{Master[[3,All,1]],Master[[3,All,2,4]]}],Method->"Spline"];
ReGV3=Interpolation[Transpose[{Master[[3,All,1]],Master[[3,All,2,5]]}],Method->"Spline"];
Print["Error2"]
e1=Master[[3,;;465,1,2]];
Print["Error3"]
List1=Flatten[ReGv1[i,j]/.i->Range[0,208]/.j->Range[0,150]];
List2=Flatten[D[ReGv1[i,j],i]/.i->Range[0,208]/.j->Range[0,150]];
List3=Flatten[D[ReGv1[i,j],j]/.i->Range[0,208]/.j->Range[0,150]];
List4=Flatten[D[ReGv1[i,j],i,j]/.i->Range[0,208]/.j->Range[0,150]];
List5=Flatten[ReGV1[i,j]/.i->Range[0,208]/.j->Range[0,150]];
List6=Flatten[D[ReGV1[i,j],i]/.i->Range[0,208]/.j->Range[0,150]];
List7=Flatten[D[ReGV1[i,j],j]/.i->Range[0,208]/.j->Range[0,150]];
List8=Flatten[D[ReGV1[i,j],i,j]/.i->Range[0,208]/.j->Range[0,150]];
Print["Error4"]
List9=Flatten[ReGv2[i,j]/.i->Range[208,788]/.j->Range[0,150]];
List10=Flatten[D[ReGv2[i,j],i]/.i->Range[208,788]/.j->Range[0,150]];
List11=Flatten[D[ReGv2[i,j],j]/.i->Range[208,788]/.j->Range[0,150]];
List12=Flatten[D[ReGv2[i,j],i,j]/.i->Range[208,788]/.j->Range[0,150]];
List13=Flatten[ReGV2[i,j]/.i->Range[208,788]/.j->Range[0,150]];
List14=Flatten[D[ReGV2[i,j],i]/.i->Range[208,788]/.j->Range[0,150]];
List15=Flatten[D[ReGV2[i,j],j]/.i->Range[208,788]/.j->Range[0,150]];
List16=Flatten[D[ReGV2[i,j],i,j]/.i->Range[208,788]/.j->Range[0,150]];
Print["Error5"]
List17=Flatten[ReGv3[P,e]/.P->Range[0,600.8,.8]/.e->e1];
List18=Flatten[D[ReGv3[P,e],P]/.P->Range[0,600.8,.8]/.e->e1];
List19=Flatten[2*Sqrt[e]*D[ReGv3[P,e],e]/.P->Range[0,600.8,.8]/.e->e1];
List20=Flatten[2*Sqrt[e]*D[ReGv3[P,e],P,e]/.P->Range[0,600.8,.8]/.e->e1];
List21=Flatten[ReGV3[P,e]/.P->Range[0,600.8,.8]/.e->e1];
List22=Flatten[D[ReGV3[P,e],P]/.P->Range[0,600.8,.8]/.e->e1];
List23=Flatten[2*Sqrt[e]*D[ReGV3[P,e],e]/.P->Range[0,600.8,.8]/.e->e1];
List24=Flatten[2*Sqrt[e]*D[ReGV3[P,e],P,e]/.P->Range[0,600.8,.8]/.e->e1];
Print["Error6"]

Export[StringJoin[Directory[],"/",input[[Dimensions[input]]],"ReGV1.csv"], Join[Transpose[{List1,List2,List3,List4}],Transpose[{List9,List10,List11,List12}],Transpose[{List17,List18,List19,List20}]]]
Export[StringJoin[Directory[],"/",input[[Dimensions[input]]],"ReGV2.csv"], Join[Transpose[{List5,List6,List7,List8}],Transpose[{List13,List14,List15,List16}],Transpose[{List21,List22,List23,List24}]]]

Exit[]

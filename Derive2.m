e1={0, .1, .2, .3, .4, .5, .6, .7, .8, .9, 1, 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7, 1.8, 1.9, 2, 2.1, 2.2, 2.3, 2.4, 2.5, 2.540308, 2.545308, 2.550308, 2.555308, 2.560308, 2.565308, 2.570308, 2.575308, 2.580308, 2.585308, 2.590308, 2.595308, 2.600308, 2.605308, 2.610308, 2.615308, 2.620308, 2.625308, 2.630308, 2.635308, 2.640308, 2.645308, 2.650308, 2.655308, 2.660308, 2.665308, 2.670308, 2.675308, 2.680308, 2.685308, 2.690308, 2.695308, 2.700308, 2.705308, 2.710308, 2.715308, 2.720308, 2.725308, 2.730308, 2.735308, 2.740308, 2.745308, 2.750308, 2.755308, 2.760308, 2.765308, 2.770308, 2.775308, 2.780308, 2.785308, 2.790308, 2.795308, 2.800308, 2.805308, 2.810308, 2.815308, 2.820308, 2.825308, 2.830308, 2.835308, 2.840308, 2.845308, 2.850308, 2.855308, 2.860308, 2.865308, 2.870308, 2.875308, 2.880308, 2.885308, 2.890308, 2.895308, 2.900308, 2.905308, 2.910308, 2.915308, 2.920308, 2.925308, 2.930308, 2.935308, 2.940308, 2.945308, 2.950308, 2.955308, 2.960308, 2.965308, 2.970308, 2.975308, 2.980308, 2.985308, 2.990308, 2.995308, 3.000308, 3.005308, 3.010308, 3.015308, 3.020308, 3.025308, 3.030308, 3.035308, 3.040308, 3.045308, 3.050308, 3.055308, 3.060308, 3.065308, 3.070308, 3.075308, 3.080308, 3.085308, 3.090308, 3.095308, 3.100308, 3.105308, 3.110308, 3.115308, 3.120308, 3.125308, 3.130308, 3.135308, 3.140308, 3.145308, 3.150308, 3.155308, 3.160308, 3.165308, 3.170308, 3.175308, 3.180308, 3.185308, 3.190308, 3.195308, 3.200308, 3.205308, 3.210308, 3.215308, 3.220308, 3.225308, 3.230308, 3.235308, 3.240308, 3.245308, 3.250308, 3.255308, 3.260308, 3.265308, 3.270308, 3.275308, 3.280308, 3.285308, 3.290308, 3.295308, 3.300308, 3.305308, 3.310308, 3.315308, 3.320308, 3.325308, 3.330308, 3.335308, 3.340308, 3.345308, 3.350308, 3.355308, 3.360308, 3.365308, 3.370308, 3.375308, 3.380308, 3.385308, 3.390308, 3.395308, 3.400308, 3.405308, 3.410308, 3.415308, 3.420308, 3.425308, 3.430308, 3.435308, 3.440308, 3.445308, 3.450308, 3.455308, 3.460308, 3.465308, 3.470308, 3.475308, 3.480308, 3.485308, 3.490308, 3.495308, 3.500308, 3.505308, 3.510308, 3.515308, 3.520308, 3.525308, 3.530308, 3.535308, 3.540308, 3.55, 3.56375, 3.5775, 3.59125, 3.605, 3.61875, 3.6325, 3.64625, 3.66, 3.67375, 3.6875,  3.70125, 3.715, 3.72875, 3.7425, 3.75625, 3.77, 3.78375, 3.7975, 3.81125, 3.825, 3.83875, 3.8525, 3.86625, 3.88, 3.89375, 3.9075, 3.92125, 3.935, 3.94875, 3.9625, 3.97625, 3.99, 4.00375, 4.0175, 4.03125, 4.045, 4.05875, 4.0725, 4.08625, 4.1, 4.2, 4.3, 4.4, 4.5, 4.6, 4.7, 4.8, 4.9, 5, 5.1, 5.2, 5.3, 5.4, 5.5, 5.6, 5.7, 5.8, 5.9, 6, 6.1, 6.2, 6.3, 6.4, 6.5, 6.6, 6.7, 6.8, 6.9, 7, 7.1, 7.2, 7.3, 7.4, 7.5, 7.6, 7.7, 7.8, 7.9, 8, 8.1, 8.2, 8.3, 8.4, 8.5, 8.6, 8.7, 8.8, 8.9, 9, 9.1, 9.2, 9.3, 9.4, 9.5, 9.6, 9.7, 9.8, 9.9, 10, 10.1, 10.2, 10.3, 10.4, 10.5, 10.6, 10.7, 10.8, 10.9, 11, 11.1, 11.2, 11.3, 11.4, 11.5, 11.6, 11.7, 11.8, 11.9, 12, 12.1, 12.2, 12.3, 12.4, 12.5, 12.6, 12.7, 12.8, 12.9, 13, 13.1, 13.2, 13.3, 13.4, 13.5, 13.6, 13.7, 13.8, 13.9, 14, 14.1, 14.2, 14.3, 14.4, 14.5, 14.6, 14.7, 14.8, 14.9, 15, 15.1, 15.2, 15.3, 15.4, 15.5, 15.6, 15.7, 15.8, 15.9, 16, 16.1, 16.2, 16.3, 16.4, 16.5, 16.6, 16.7, 16.8, 16.9, 17, 17.1, 17.2, 17.3, 17.4, 17.5, 17.6, 17.7, 17.8, 17.9, 18, 18.1, 18.2, 18.3, 18.4, 18.5, 18.6, 18.7, 18.8, 18.9, 19, 19.1, 19.2, 19.3, 19.4, 19.5, 19.6, 19.7, 19.8, 19.9, 20, 20.1, 20.2, 20.3, 20.4, 20.5, 20.6, 20.7, 20.8, 20.9, 21., 21.1, 21.2, 21.3, 21.4, 21.5, 21.6, 21.7, 21.8, 21.9, 22., 22.1, 22.2, 22.3, 22.4, 22.5, 22.6, 22.7, 22.8, 22.9, 23., 23.1, 23.2, 23.3, 23.4, 23.5}^2; (*s abscissa*)
Par={-158.90117114622294, 2.643945190802571, 1.8, 0, 0};

input = $CommandLine

MasterIm = Import[StringJoin[Directory[],"/",input[[Dimensions[input]]],".xml"]]; (*Import the table for interpolation extrapolation*)
MasterRe2 = Import[StringJoin[Directory[],"/",input[[Dimensions[input]-1]],".xml"]]; (*Import the table for interpolation extrapolation*)
MasterRe1 = Import[StringJoin[Directory[],"/",input[[Dimensions[input]-2]],".xml"]]; (*Import the table for interpolation extrapolation*)
Sub1 = N[Transpose[{MasterIm[[2,All,1]],MasterIm[[2,All,2,1]]}]]; (*Extract the subtables*)
Sub2 = N[Transpose[{MasterIm[[2,All,1]],MasterIm[[2,All,2,2]]}]];
Sub3 = N[Transpose[{MasterIm[[2,All,1]],MasterIm[[2,All,2,3]]}]];
Sub4 = N[Transpose[{MasterRe2[[2,All,1]],MasterRe2[[2,All,2]]}]];
Sub5 = N[Transpose[{MasterRe1[[2,All,1]],MasterRe1[[2,All,2]]}]];

ImG=Interpolation[Sub1,Method->"Spline"];(*Turn the tables into an interpolation*)
ReGV1=Interpolation[Sub5,Method->"Spline"];
ImGV1=Interpolation[Sub2,Method->"Spline"];
GV1[P_,s_]:=(ReGV1[P,s]+I*ImGV1[P,s])[[1]];
ReGV2=Interpolation[Sub4,Method->"Spline"];
ImGV2=Interpolation[Sub3,Method->"Spline"];
GV2[P_,s_]:=(ReGV2[P,s]+I*ImGV2[P,s])[[1]];

V[s_]:=Par[[1]]*(Par[[2]]^4/(Par[[2]]^4+(s-4*Par[[3]]^2)^2))^2 (*TMatrix and Spectral function definitions*)
TMat[P_,s_]:=V[s]/(1-GV2[P,s])
Spectral[P_,s_]:=-18/Pi*(ImG[P,s]+Im[Par[[1]]*GV1[P,s]^2/(1-GV2[P,s])])
SpectralInt=Interpolation[Flatten[Table[{{P,e1[[i]]},Spectral[P,e1[[i]]]},{P,0,600.8,.8},{i,1,462}],1]];

ListT = Flatten[Table[{P,e1[[i]],TMat[P,e1[[i]]]},{P,0,600.8,.8},{i,1,462}],1]; (*Calculate the derivatives and the function itself*)
List0 = Flatten[Table[SpectralInt[P, e1[[i]]], {P, 0, 600.8, .8}, {i, 1, 462}]];
List1 = Flatten[Table[D[SpectralInt[P,e],P]/.{P->i,e->e1[[j]]},{i,0,600.8,.8},{j,1,462}]];
List2 = Flatten[Table[2*Sqrt[e]*D[SpectralInt[P,e],e]/.{P->i,e->e1[[j]]},{i,0,600.8,.8},{j,1,462}]]; (*2*Sqrt[e]* is to change the derivative from d/ds to d/d(sqrt(s))*)
List3 = Flatten[Table[2*Sqrt[e]*D[SpectralInt[P,e],P,e]/.{P->i,e->e1[[j]]},{i,0,600.8,.8},{j,1,462}]];
(*List4 = Flatten[TMat[P, e] /. P -> Range[0, 600.8, .8] /. e -> e1];
List5 = Flatten[D[TMat[P, e], P] /. P -> Range[0, 600.8, .8] /. e -> e1];
List6 = Flatten[2*Sqrt[e]*D[TMat[P, e], e] /. P -> Range[0, 600.8, .8] /. e -> e1];
List7 = Flatten[2*Sqrt[e]*D[TMat[P, e], P, e] /. P -> Range[0, 600.8, .8] /. e -> e1];*)

Export[StringJoin[Directory[],"/",input[[Dimensions[input]]],".csv"], Transpose[{ListT[[All, 1]], ListT[[All, 2]], Re[ListT[[All, 3]]], Im[ListT[[All, 3]]], List0, List1, List2, List3}]] (*Export the table*)

Exit[]
